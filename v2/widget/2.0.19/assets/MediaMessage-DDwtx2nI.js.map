{"version":3,"file":"MediaMessage-DDwtx2nI.js","sources":["packages/chat-widget-components/src/components/MediaMessage/AttachmentIcon.tsx","packages/chat-widget-components/src/components/MediaMessage/MediaMessage.tsx"],"sourcesContent":["const AttachmentIcon = () => {\n  return (\n    <svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16' fill='none'>\n      <path\n        d='M11 3.99984V11.6665C11 13.1398 9.80669 14.3332 8.33335 14.3332C6.86002 14.3332 5.66669 13.1398 5.66669 11.6665V3.33317C5.66669 2.41317 6.41335 1.6665 7.33335 1.6665C8.25335 1.6665 9.00002 2.41317 9.00002 3.33317V10.3332C9.00002 10.6998 8.70002 10.9998 8.33335 10.9998C7.96669 10.9998 7.66669 10.6998 7.66669 10.3332V3.99984H6.66669V10.3332C6.66669 11.2532 7.41335 11.9998 8.33335 11.9998C9.25335 11.9998 10 11.2532 10 10.3332V3.33317C10 1.85984 8.80669 0.666504 7.33335 0.666504C5.86002 0.666504 4.66669 1.85984 4.66669 3.33317V11.6665C4.66669 13.6932 6.30669 15.3332 8.33335 15.3332C10.36 15.3332 12 13.6932 12 11.6665V3.99984H11Z'\n        fill='#ffffff'\n      />\n      <mask\n        id='mask0_3460_15772'\n        style={{ maskType: 'luminance' }}\n        maskUnits='userSpaceOnUse'\n        x='4'\n        y='0'\n        width='8'\n        height='16'\n      >\n        <path\n          d='M11 3.99984V11.6665C11 13.1398 9.80669 14.3332 8.33335 14.3332C6.86002 14.3332 5.66669 13.1398 5.66669 11.6665V3.33317C5.66669 2.41317 6.41335 1.6665 7.33335 1.6665C8.25335 1.6665 9.00002 2.41317 9.00002 3.33317V10.3332C9.00002 10.6998 8.70002 10.9998 8.33335 10.9998C7.96669 10.9998 7.66669 10.6998 7.66669 10.3332V3.99984H6.66669V10.3332C6.66669 11.2532 7.41335 11.9998 8.33335 11.9998C9.25335 11.9998 10 11.2532 10 10.3332V3.33317C10 1.85984 8.80669 0.666504 7.33335 0.666504C5.86002 0.666504 4.66669 1.85984 4.66669 3.33317V11.6665C4.66669 13.6932 6.30669 15.3332 8.33335 15.3332C10.36 15.3332 12 13.6932 12 11.6665V3.99984H11Z'\n          fill='white'\n        />\n      </mask>\n      <g mask='url(#mask0_3460_15772)'></g>\n    </svg>\n  )\n}\n\nexport default AttachmentIcon\n","import { SyntheticEvent, useEffect, useRef, useState } from 'react'\n\nimport { MAX_RETRIES, Media, MEDIA_ERR_NETWORK } from '@td-org/chat-widget-shared'\n\nimport AttachmentIcon from './AttachmentIcon.tsx'\nimport { MediaMessageProps } from './types.ts'\n\nimport classes from './MediaMessage.module.scss'\n\nconst convertVideoUrl = (url: string): string => {\n  if (url.startsWith('blob:')) {\n    return url\n  } else {\n    return `${url}#t=0.001`\n  }\n}\n\nconst MediaMessage = (props: MediaMessageProps) => {\n  const { type, url, getContentTemporaryUrl, onError, onMediaLoadedData, children } = props\n\n  const mediaRef = useRef<HTMLVideoElement & HTMLAudioElement>(null)\n  const imageRef = useRef<HTMLImageElement>(null)\n  const currentTime = useRef<number>(0)\n  const [mediaSourceUrl, setMediaSourceUrl] = useState(url)\n  const retryTimes = useRef<number>(0)\n\n  useEffect(() => {\n    if (type === 'video' && url && url.startsWith('blob:')) {\n      mediaRef.current?.load()\n    }\n  }, [type, url])\n\n  const switchSource = (newSource: string) => {\n    if (mediaRef.current) {\n      setMediaSourceUrl(newSource)\n      mediaRef.current.load()\n      mediaRef.current.play()\n    }\n  }\n\n  const seek = (time: number) => {\n    if (mediaRef.current) {\n      mediaRef.current.currentTime = time\n    }\n  }\n  const onSourceError = async (e: SyntheticEvent<HTMLMediaElement>) => {\n    if (onError) {\n      onError(new Error(`failed to load media. Url: ${e.currentTarget.currentSrc}`))\n    }\n    const errorCode = e.currentTarget.error?.code\n    if (getContentTemporaryUrl && errorCode === MEDIA_ERR_NETWORK) {\n      if (retryTimes.current >= MAX_RETRIES) return\n      retryTimes.current = retryTimes.current + 1\n      try {\n        const newMediaUrl = await getContentTemporaryUrl()\n        if (newMediaUrl) {\n          switchSource(newMediaUrl)\n          seek(currentTime.current)\n        }\n      } catch {\n        const error = new Error('failed to fetch new media url.')\n        if (onError) {\n          onError(error)\n        }\n      }\n    }\n  }\n\n  const onImgError = async (e: SyntheticEvent<HTMLImageElement>) => {\n    if (onError) {\n      onError(new Error(`failed to load image. Url: ${e.currentTarget.currentSrc}`))\n    }\n    if (getContentTemporaryUrl) {\n      if (retryTimes.current >= MAX_RETRIES) return\n      retryTimes.current = retryTimes.current + 1\n      try {\n        const newMediaUrl = await getContentTemporaryUrl()\n        if (newMediaUrl && imageRef.current) {\n          setMediaSourceUrl(newMediaUrl)\n        }\n      } catch {\n        const error = new Error('failed to fetch new image url.')\n        if (onError) {\n          onError(error)\n        }\n      }\n    }\n  }\n\n  const onTimeUpdate = () => {\n    if (mediaRef.current && mediaRef.current.currentTime) {\n      currentTime.current = mediaRef.current.currentTime\n    }\n  }\n\n  const onFileClick = async () => {\n    const latestUrl = getContentTemporaryUrl ? await getContentTemporaryUrl() : url\n    if (!latestUrl) return\n\n    window.open(latestUrl, '_blank')\n  }\n\n  const onMediaLoaded = () => {\n    onMediaLoadedData?.()\n  }\n\n  switch (type) {\n    case Media.Audio:\n      return (\n        <audio\n          data-testid='customAudio'\n          ref={mediaRef}\n          className={classes.customAudio}\n          controls\n          onError={onSourceError}\n          onTimeUpdate={onTimeUpdate}\n          onLoadedData={onMediaLoaded}\n        >\n          <source src={mediaSourceUrl} type='audio/mpeg' />\n          <source src={mediaSourceUrl} type='audio/ogg' />\n          <track src='' kind='captions' srcLang='en' label='english_captions' />\n          Your browser does not support the audio tag.\n        </audio>\n      )\n    case Media.Video:\n      return (\n        <video\n          data-testid='customVideo'\n          ref={mediaRef}\n          className={classes.customVideo}\n          controls\n          playsInline\n          onError={onSourceError}\n          onTimeUpdate={onTimeUpdate}\n          onLoadedData={onMediaLoaded}\n        >\n          <source src={convertVideoUrl(mediaSourceUrl)} type='video/mp4' />\n          <track src='' kind='captions' srcLang='en' label='english_captions' />\n          Your browser does not support the video tag.\n        </video>\n      )\n    case Media.Image:\n      return (\n        <img\n          src={mediaSourceUrl}\n          ref={imageRef}\n          alt='This is an img attachment'\n          onError={onImgError}\n          className={classes.customImage}\n          onLoad={onMediaLoaded}\n        />\n      )\n    case Media.File:\n      return (\n        <button data-testid='customFile' aria-label='file' className={classes.customFile} onClick={onFileClick}>\n          <AttachmentIcon />\n          <span>{children}</span>\n        </button>\n      )\n    default:\n      return <></>\n  }\n}\n\nexport default MediaMessage\n"],"names":["AttachmentIcon","jsxs","jsx","convertVideoUrl","url","MediaMessage","props","type","getContentTemporaryUrl","onError","onMediaLoadedData","children","mediaRef","useRef","imageRef","currentTime","mediaSourceUrl","setMediaSourceUrl","useState","retryTimes","useEffect","_a","switchSource","newSource","seek","time","onSourceError","e","errorCode","MEDIA_ERR_NETWORK","MAX_RETRIES","newMediaUrl","error","onImgError","onTimeUpdate","onFileClick","latestUrl","onMediaLoaded","Media","classes","Fragment"],"mappings":"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"}